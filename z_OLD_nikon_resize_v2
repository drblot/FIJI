//open, recolour and rescale large .tifs generated by nikon microscopes and .nd2 which cant be opened unless as tif

input = getDirectory("Choose a Directory");
output = getDirectory("select or create destination directory");
suffix = ".tif";

function action(input, output, filename) {

//open (input + filename);
//open runs bioformats in linx and breaks automation wihout the below fix

run ("Bio-Formats Macro Extensions");
Ext.openImagePlus(input + filename);
fname = getTitle();

Stack.setChannel(1);													// SELECT CHANNEL OF INTEREST
run("Cyan");														// RUN COMMAND
run("Enhance Contrast", "saturated=0.20");										// RUN COMMAND
//setMinAndMax(5, 1000);													// RUN COMMAND
Stack.setChannel(2);													// SELECT CHANNEL OF INTEREST
run("Enhance Contrast", "saturated=0.20");
run("Yellow");
Stack.setChannel(3);													// SELECT CHANNEL OF INTEREST
run("Enhance Contrast", "saturated=0.20");
run("Grays");

//Stack.setActiveChannels("001");										//turn off chan12
run("Scale...", "x=- y=- z=1.0 width=8000 height=8000 depth=3 interpolation=Bilinear create");
saveAs("tiff",output+fname);
                                
                        close();
}

setBatchMode(true); 
list = getFileList(input);
for (i = 0; i < list.length; i++)	
if(endsWith(list[i], suffix))  												 //process only .tif
action(input, output, list[i]);
setBatchMode(false);
